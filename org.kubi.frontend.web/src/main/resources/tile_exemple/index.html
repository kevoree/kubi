<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>SmartHome : tile style</title>

  <link rel="stylesheet" href="css/demo-styles.css" />
  <script src="js/modernizr-1.5.min.js"></script>

    <script src="../nunjucks.js"></script>
    <script src="../org.kubi.model-all.js"></script>
    <script src="../org.kevoree.modeling.database.websocket.WebSocket.js"></script>
    <script src="../canvasjs.min.js"></script>
</head>

<body>
 <header>
   <a href="http://wwwfr.uni.lu/snt" class="tutorial-link">Made by the SnT</a>
 </header>
  <!--===============================Start Demo====================================================-->
<div class="demo-wrapper">
<!-- classnames for the pages should include: 1) type of page 2) page name-->
  <div class="s-page random-restored-page">
    <h2 class="page-title">Economic move</h2>
    <div class="close-button s-close-button">x</div>
    <div id="chartContainer"></div>
  </div>
  <div class="s-page custom-page">
    <h2 class="page-title">Thank You!</h2>
    <div class="close-button s-close-button">x</div>
  </div>
  <div class="r-page random-r-page">

    <div class="page-content">
      <h2 class="page-title">App Screen</h2>
      <p>Chew iPad power cord chew iPad power cord attack feet chase mice leave dead animals as gifts and stick butt in face chew iPad power cord. Chase mice. Run in circles use lap as chair why must they do that. Intrigued by the shower destroy couch leave hair everywhere sleep on keyboard chew iPad power cord. Use lap as chair. Missing until dinner time stand in front of the computer screen, intently sniff hand. Find something else more interesting. Destroy couch play time so inspect anything brought into the house hate dog burrow under covers. Sleep on keyboard destroy couch so hate dog so hide when guests come over. Chase mice destroy couch lick butt throwup on your pillow use lap as chair yet intrigued by the shower but climb leg. Stare at ceiling make muffins or hunt anything that moves claw drapes. Intently sniff hand intrigued by the shower. Why must they do that. Cat snacks leave dead animals as gifts or inspect anything brought into the house sweet beast so stare at ceiling give attitude. Flop over claw drapes but sun bathe lick butt, and chase mice. Rub face on everything lick butt leave hair everywhere lick butt, missing until dinner time for use lap as chair lick butt. Make muffins leave dead animals as gifts play time. Chew foot intrigued by the shower stare at ceiling inspect anything brought into the house yet hopped up on goofballs. 

      Hunt anything that moves intently sniff hand for hunt anything that moves play time. Chew foot climb leg throwup on your pillow so lick butt yet make muffins hate dog. Intrigued by the shower. Intently sniff hand shake treat bag. Cat snacks burrow under covers make muffins but all of a sudden go crazy find something else more interesting. Flop over chase mice. Give attitude. Inspect anything brought into the house. Stick butt in face sun bathe so find something else more interesting and intrigued by the shower. Rub face on everything use lap as chair. 

      Under the bed claw drapes chase mice but leave hair everywhere yet make muffins yet claw drapes. Use lap as chair. Find something else more interesting stretch for under the bed. Nap all day intrigued by the shower, hate dog sweet beast intently sniff hand so hate dog nap all day. Swat at dog hide when guests come over and mark territory chase mice for cat snacks. Use lap as chair. Lick butt throwup on your pillow need to chase tail. 

      Mark territory. Stick butt in face shake treat bag yet hunt anything that moves, yet hopped up on goofballs yet stare at ceiling under the bed. Give attitude chase imaginary bugs stretch so hunt anything that moves so hide when guests come over but intrigued by the shower find something else more interesting. Make muffins behind the couch for chew foot. Sweet beast flop over but throwup on your pillow. Intently sniff hand use lap as chair and missing until dinner time and chase imaginary bugs. 
      </p>
    </div>
    
    <div class="close-button r-close-button">x</div>
  </div>
<!--each tile should specify what page type it opens (to determine which animation) and the corresponding page name it should open-->
  <div class="dashboard clearfix">
    <ul class="tiles">
      <div class="col1 clearfix">
        <li class="tile tile-big tile-1 slideTextUp" data-page-type="r-page" data-page-name="random-r-page">
          <div><p>I don't want to do anything. I'm the one in charge !</p></div>
          <div><p>View all tasks</p></div>
        </li>
        <li class="tile tile-2xbig tile-2" data-page-type="s-page" data-page-name ="random-restored-page">
            <figure>
                <div>
                    <p>Economic move : close the window in 10 minutes.</p>
                    <ul>
                        <li>Temperature : 20°C (-0.5°C)</li>
                        <li>Air quality : 80%  (+6  % )</li>
                    </ul>
                </div>
                <p class="tile-caption caption-left">Slide-out Caption from left</p>
            </figure>
        </li>
          <!--
        <li class="tile tile-small last tile-3" data-page-type="r-page" data-page-name="random-r-page">
          <p class="icon-calendar-alt-fill"></p>
        </li>
          -->
        <li class="tile tile-2xbig tile-4 fig-tile" data-page-type="r-page" data-page-name="random-r-page">
          <figure>
            <img src="images/blue.jpg" />
            <figcaption class="tile-caption caption-left"><button href="www.google.fr">Slide-out Caption from left</button></figcaption>
          </figure>
        </li>
      </div>
    </ul>
  </div><!--end dashboard-->

</div>
<!--====================================end demo wrapper================================================-->
  <script src="js/jquery-1.8.2.min.js"></script>
  <script src="js/scripts.js"></script>



 <script>
 var last_timestamp = (new Date()).getTime();
 var kubiModel = new org.kubi.KubiModel();
 function btclick(time, uuid, params) {
     kubiModel.universe(0).time(time).lookup(uuid).then(function (resolved) {
         resolved.exec(params, function (rpcRes) {
                $("#execution-result").html("Model based RPC result=" + rpcRes);
             });
         });
     }
     kubiModel.setContentDeliveryDriver(new org.kevoree.modeling.database.websocket.WebSocketClient("ws://" + location.host + "/cdn"));
     kubiModel.connect().then(function (e) {
     if (e) {
        console.error(e);
     } else {
        initGraph();
     }
 });
 </script>

 <script>
 var chart;
 windowSize = 60;
 var dataPoints = {};
 function initGraph(){
     chart = new CanvasJS.Chart("chartContainer",
             {
                 width: 1000,
                 height: 500,
                 backgroundColor: "#708090",
                 theme: "theme3",
                 title: {
                     text: "graph of the parameter influenced by the opening of the window depending of the time(hour)",
                     fontColor: "white"
                 },
                 axisX: {
                     valueFormatString: "HH:mm:ss",
                     interval: 3600,
                     intervalType: "second",
                     labelFontColor: "#white",
                     lineColor: "white",
                     lineThickness: 1,
                     tickColor: "white",
                     tickLength: 5,
                     tickThickness: 1,


                     lineThickness: 1,
                     gridColor: "white",
                     gridThickness: 1
                 },
                 axisY: {
                     title: "truc",
                     titleFontColor: "white",
                     lineColor: "white",
                     lineThickness: 1,
                     gridColor: "white",
                     gridThickness: 1,
                     labelFontColor: "white",
                     tickColor: "white",
                     tickLength: 5,
                     tickThickness: 1
                 },
                 legend: {
                     verticalAlign: "bottom",
                     horizontalAlign: "center",
                     fontSize: 16,
                     fontColor: "white"
                 },
                 toolTip: {
                     shared: true
                 },
                 data: []
             }
     );
     var currentView = kubiModel.universe(0).time(last_timestamp);
     var groupListenerID = kubiModel.nextGroup();
     currentView.getRoot().then(function (root) {
         root.traversal().traverse(org.kubi.meta.MetaEcosystem.REF_DEVICES).done().then(function (devices){
             var d;
             for(d = 0; d< devices.length; d++)
             {
                 var device = devices[d];
                 // add a curb describing the device on the chart
                 chart.options.data.push({type: "line", showInLegend: true, name: device.getName(), dataPoints: []});
                 dataPoints[device.getName()]=[];
                 // add old data to the chart
                 device.traversal().traverse(org.kubi.meta.MetaDevice.REF_PARAMETERS).withAttribute(org.kubi.meta.MetaParameter.ATT_NAME, "name").done().then(function (params){
                     if (params.length != 0) {
                         var param = params[0];
                         param.listen(groupListenerID, function (param, metaTabl){
                             param.parent().then(function(parent) {
                                 addDataPointWithSerie({
                                     x: new Date(param.now()),
                                     y: parseFloat(param.getValue())
                                 }, parent.getName());
                             });
                         });
                         param.jump(param.now()-1000).then(function (paramTimed){
                             param.parent().then(function (parent){
                                 addPreviousValues(paramTimed, parent.getName());
                             });
                         });
                     }
                 });
             }
         });
     });
 }
 function addPreviousValues(paramTimed, deviceName){
     if((paramTimed.now() > last_timestamp-30000) && (paramTimed.getValue()!= undefined)) {
         dataPoints[deviceName].push({x: new Date(paramTimed.now()), y: parseFloat(paramTimed.getValue())});
         paramTimed.jump(paramTimed.now() - 1000).then(function (param1){
             addPreviousValues(param1, deviceName);
         });
     }
     else{
         var unsortedDataPoints = dataPoints[deviceName];
         var sortedDataPoints = [];
         for(var i=0;i<unsortedDataPoints.length;i++){
             sortedDataPoints.push(unsortedDataPoints.slice(unsortedDataPoints.length-i-1,unsortedDataPoints.length-i)[0])
         }
         addDataPointsWithSerieName(sortedDataPoints,deviceName);
         initPage();
         chart.render();
     }
 }

 /**
  *Add a set of points to the chart
  * @param  value the set of poins
  * @param serieName the name of the serie that you want to add the points
  * [
  *     {x: new Date(timestamp), y: Float_value},
  *     {x: new Date(timestamp), y: Float_value}
  * ]
  **/
 function addDataPointsWithSerieName(values, serieName) {
     var dpsCollection;
     var index;
     for(var d in chart.options.data){
         data = chart.options.data[d];
         if(data.name.equals(serieName)){
             dpsCollection = data.dataPoints;
             index = d;
         }
     }
     if(dpsCollection != null && index != null) {
         for (var point in values) {
             dpsCollection.push(values[point]);
             if (dpsCollection.length > windowSize) {
                 dpsCollection.shift();
             }
         }
     }
     else{
         console.error("Bad series name ",serieName, " : device not in the data set of the chart.");
     }
     this.chart.render();
 }
 /**
  * Add the point to the chart in the first set of data
  * @param point
  * {x: new Date(timestamp), y: Float_value}
  */
 function addDataPoint(point) {
     var dpsCollection = chart.options.data[0].dataPoints;
     dpsCollection.push(point);
     if(dpsCollection.length > windowSize) {
         dpsCollection.shift();
     }
     this.chart.render();
 }
 /**
  * Add the point to the chart
  * @param point
  * {x: new Date(timestamp), y: Float_value}
  * @param serie name
  *     the name of the chart where you want to add the point (should be the name of the device)
  */
 function addDataPointWithSerie(point, serie) {
     var dpsCollection;
     var index;
     for(var i in chart.options.data){
         data = chart.options.data[i];
         if(data.name.equals(serie)){
             dpsCollection = data.dataPoints;
             index=i;
         }
     }
     if(dpsCollection != null && index!=null) {
         var dpsCollection = chart.options.data[index].dataPoints;
         dpsCollection.push(point);
         if (dpsCollection.length > windowSize) {
             dpsCollection.shift();
         }
     }
     else{
         console.error("Bad series name (=",serie ,") : device not in the data set of the chart.");
     }
     this.chart.render();
 }
 function initPage(){
     /*var currentView = kubiModel.universe(0).time(last_timestamp);
     currentView.getRoot().then(function (root) {
         nunjucks.configure({autoescape: true});
         try {
             // init the graph
             nunjucks.renderString($("#ecosystem-template").html(), {ecosystem: root,autoRefresh:true,autoNow:true}, function (err, res) {
                 if (err) {
                     console.log(err);
                 }
                 $("#ecosystem").html(res);
                 var currentView = kubiModel.universe(0).time((new Date()).getTime());
                 currentView.getRoot().then(function (root) {
                     root.traversal().traverse(org.kubi.meta.MetaEcosystem.REF_DEVICES).done().then(function (devices){
                         var d;
                         for(d = 0; d<devices.length ; d++){
                             var device = devices[d];
                             device.traversal().traverse(org.kubi.meta.MetaDevice.REF_PARAMETERS).withAttribute(org.kubi.meta.MetaParameter.ATT_NAME, "name").done().then(function (params) {
                                 var param = params[0];
                                 param.parent().then(function(parent){
                                     addDataPointWithSerie({x: new Date(param.now()), y: parseFloat(param.getValue())}, parent.getName());
                                 });
                             });
                         }
                     });
                 });
             });
         } catch(e){
             console.error(e);
         }
     });*/
 }
 </script>
</body>
</html>
