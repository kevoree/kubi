<link rel="import" href="../../bower_components/polymer/polymer.html"/>


<!-- kubi model -->
<link rel="import" href="../kubi-model/kubi-model.html"/>

<!-- kubi dependencies -->
<script src="/js/js/org.kubi.model-all.js"></script>
<script src="/js/js/org.kevoree.modeling.drivers.websocket.js"></script>



<!-- epoch chart dependencies -->
<script src="jQuery.js"></script>

<script src="/epoch.0.6.0/d3.min.js"></script>
<script src="/epoch.0.6.0/epoch.min.js"></script>

<link rel="stylesheet" type="text/css" href="/epoch.0.6.0/epoch.min.css"/>

<!-- js associated -->
<script src="./kubi-chart-epoch.js"></script>

<dom-module id="kubi-chart-epoch">
    <template>
        <kubi-model id="modelHandlerEpoch" on-model-connected="modelConnected"></kubi-model>
        <h3>Graph Epoch describing the data from devises.</h3>
        <div id="lineChart" class="epoch category10"></div>
        <p>Legend : </p>
        <div id="epochLegend"></div>
    </template>
</dom-module>


<script>

    Polymer({
        is: "kubi-chart-epoch",

        properties: {
            time: {
                type: Number,
                observer: 'updateGraph'
            },
            scale: {
                type: Number,
                observer: 'updateGraph'
            },
            devices: {
                type: Array,
                value: ["plug"],
                observer: 'updateGraph'
            },
            wantperiod: {
                type: String,
                value: false,
                observer: 'updateGraph'
            }
        },
        updateGraph: function (event) {
            if (this.time != undefined && this.scale != undefined && this.devices != undefined) {
                try {
                    console.log("-- Epoch : updateGraph");
                    updateEpochChartSettings(this.time, this.scale, this.devices, this.wantperiod);
                } catch (e) {
                    console.error(e);
                }

            }
        },
        modelConnected : function(event, details){
            console.log("-- Epoch : modelConnected");
            initEpochChart(details.value);
        },

        ready: function () {
            try{
                if(this.$.modelHandlerEpoch.modelAvailable()) {
                    initEpochChart(this.$.modelHandlerEpoch.model());
                }
                KubiEpoch.chart = $(this.$.lineChart).epoch({
                    type: 'line',
                    data: lineChartData,
                    height: 400,
                    width: 1200,
                    tickFormats: {
                        bottom: function(x){return prettyDate(new Date(x));}
                    },
                    margins: {
                        top: 50, right: 60, bottom: 30, left: 40
                    },
                    axes: ['left', 'bottom'],
                    ticks : { bottom: 5, left: 5 }
                });

            } catch(er){
                console.error(er);
            }
        }
    });

    function prettyDate(date) {
        return (date.getDate()<10?("0"+date.getDate()):date.getDate())+"/"
                +   ((date.getMonth()+1)<10?("0"+(date.getMonth()+1)):(date.getMonth()+1))+"/"
                +   (date.getFullYear()) +" At "
                +   (date.getHours()<10?("0"+date.getHours()):date.getHours()) +":"
                +   (date.getMinutes()<10?("0"+date.getMinutes()):date.getMinutes())+":"
                +   (date.getSeconds()<10?("0"+date.getSeconds()):date.getSeconds());
    }
</script>
