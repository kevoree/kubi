<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="/js/js/org.kubi.model-all.js"></script>
<script src="/js/js/org.kevoree.modeling.database.websocket.WebSocket.js"></script>

<dom-module name="kubi-model">
    <template>

    </template>
</dom-module>

<script>
    var modelConnectedCallbacks = [];
    var kubiModel2;
    var modelConnected;
    var modelConnecting;
    // --------------
//    if(kubiModel2 == undefined){
//        kubiModel2 = new org.kubi.KubiModel();
//    }
    // --------------
    if( modelConnected == undefined){
        modelConnected = false;
    }
    if( modelConnecting == undefined){
        modelConnecting = false;
    }
    Polymer({
        is: "kubi-model",
        ready: function() {
            var selfKubiModel = this;
            if(!modelConnecting && !modelConnected) {
                modelConnecting = true;
                // --------------
                kubiModel2 = new org.kubi.KubiModel();
                // --------------
                console.log("starting ... :D");
                var dataBaseConnection2 = new org.kevoree.modeling.drivers.websocket.WebSocketCDNClient("ws://" + location.host + "/cdn");
                kubiModel2.setContentDeliveryDriver(dataBaseConnection2);
                kubiModel2.connect(function(err){
                    if(err) {
                        console.error(err);
                    } else {
                        modelConnected = true;
                        console.log("The model is initializing in the kubi-model component.")
                        selfKubiModel.fire("model-connected", {value: kubiModel2});
                        for(var callbackIndex =0; callbackIndex<modelConnectedCallbacks.length; callbackIndex++){
                            modelConnectedCallbacks[callbackIndex](kubiModel2);
                        }
                    }
                });
            }else if(!modelConnected) {
                modelConnectedCallbacks.push(function(model){
                   selfKubiModel.fire('model-connected',{value: model});
                });
            }
            else{
                selfKubiModel.fire("model-connected", {value: kubiModel2});
            }
        },
        get model() {
            return kubiModel2;
        },
        modelAvailable : function() {
            return modelConnected;
        },
        get lastTime() {
            return last_timestamp2;
        }
    });
</script>