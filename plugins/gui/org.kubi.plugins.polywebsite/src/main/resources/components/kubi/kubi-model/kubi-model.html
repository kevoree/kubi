<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="/js/org.kubi.model.js"></script>
<script src="/js/org.kevoree.modeling.microframework.browser.js"></script>
<script src="/js/org.kevoree.modeling.drivers.websocket.js"></script>


<script type="text/javascript" src="/js/paperclip.js"></script>
<script type="text/javascript" src="/js/parser.js"></script>


<dom-module name="kubi-model">
    <template>

    </template>
</dom-module>



<script>
    var modelConnectedCallbacks = [];
    var kubiModel2;
    var modelConnected;
    var modelConnecting;

    if( modelConnected == undefined){
        modelConnected = false;
    }
    if( modelConnecting == undefined){
        modelConnecting = false;
    }
    Polymer({
        is: "kubi-model",
        ready: function() {
            var selfKubiModel = this;
            if(!modelConnecting && !modelConnected) {
                modelConnecting = true;

                var dataBaseConnection2 = new org.kevoree.modeling.drivers.websocket.WebSocketPeer("ws://localhost:8082/cdn");
                var dm = org.kevoree.modeling.memory.manager.DataManagerBuilder.create().withContentDeliveryDriver(dataBaseConnection2).build();
                kubiModel2 = new org.kubi.KubiModel(dm);

                kubiModel2.connect(function(err){
                    if(err) {
                        console.error(err);
                    } else {
                        modelConnected = true;
                        console.log("The model is initializing in the kubi-model component.")
                        selfKubiModel.fire("model-connected", {value: kubiModel2});
                        for(var callbackIndex =0; callbackIndex<modelConnectedCallbacks.length; callbackIndex++){
                            modelConnectedCallbacks[callbackIndex](kubiModel2);
                        }
                    }
                });
            }else if(!modelConnected) {
                modelConnectedCallbacks.push(function(model){
                   selfKubiModel.fire('model-connected',{value: model});
                });
            }
            else{
                selfKubiModel.fire("model-connected", {value: kubiModel2});
            }
        },
        get model() {
            return kubiModel2;
        },
        modelAvailable : function() {
            return modelConnected;
        },
        get lastTime() {
            return last_timestamp2;
        }
    });

/*
var KubiModel = KubiModel || {
isConnecting: false,
isConnected: false,
connectionCallbacks: [],

connect: function (callback) {
if (!this.isConnected) {
if (!this.isConnecting) {
this.isConnecting = true;

var dataBaseConnection = new org.kevoree.modeling.drivers.websocket.WebSocketPeer("ws://" + location.hostname + ":8082/cdn");
var dataManager = org.kevoree.modeling.memory.manager.DataManagerBuilder.create().withContentDeliveryDriver(dataBaseConnection).build();
KubiModel.modelInstance = new org.kubi.KubiModel(dataManager);

KubiModel.connectionCallbacks.push(callback);

KubiModel.modelInstance.connect(function (err) {
if (err) {
console.error(err);
KubiModel.isConnecting = false;
} else {
KubiModel.modelContext = KubiModel.modelInstance.createModelContext();
KubiModel.modelContext.set((new Date()).getTime(),org.kevoree.modeling.KConfig.END_OF_TIME,0,0);

KubiModel.isConnected = true;
console.log("ModelConnected");
KubiModel.connectionCallbacks.forEach(function (cb) {
cb(KubiModel.modelInstance);
});
KubiModel.connectionCallbacks = [];
}
});
} else {
KubiModel.connectionCallbacks.push(callback);
}
} else {
callback(KubiModel.modelInstance);
}
}
};
*/
</script>

