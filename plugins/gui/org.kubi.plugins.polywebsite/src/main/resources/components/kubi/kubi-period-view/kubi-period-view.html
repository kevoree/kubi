<link rel="import" href="../../bower_components/polymer/polymer.html"/>

<link rel="import" href="../kubi-model/kubi-model.html"/>



<script src="/js/paperclip.js"></script>
<script src="/js/parser.js"></script>

<script src="/js/org.kubi.model.js"></script>
<script src="/js/org.kevoree.modeling.microframework.browser.js"></script>
<script src="/js/org.kevoree.modeling.drivers.websocket.js"></script>


<script src="./kubi-period-view.js"></script>

<dom-module id="kubi-period-view">
    <template>
        <div>
            <kubi-model id="modelHandlerPeriod" on-model-connected="modelConnected"></kubi-model>

            <div id="periodView"></div>

            <script id="periodView_template" type="text/x-handlebars-template">
                <ul>
                    <repeat each="{{ecosystem.technologies}}" as="techno">
                        <li>
                            <h4>{{techno.name}} ({{ techno.now | timestampToDateConverter }}) :</h4> <!--{{techno.now()|timestampToDate}}-->
                            <!--<h4>{{techno.name}} ({{ techno.now }}) :</h4>-->
                            <ul>
                                <repeat each="{{techno.devices}}" as="device">
                                    <li>
                                        <ul class="collection with-header">
                                            <li class="collection-header"><h5>Device : {{device.name}}</h5></li>
                                            <repeat each="{{device.stateParameters}}" as="param">
                                                <li class="collection-item">Parameter : {{param.name}}</li>
                                                <li class="collection-item">Value : {{param.value}}</li>
                                                <repeat each="{{param.period}}" as="p">
                                                    <li class="collection-item">Period :{{p.period}}</li>
                                                </repeat>
                                            </repeat>
                                        </ul>
                                    </li>
                                </repeat>
                            </ul>
                        </li>
                    </repeat>
                </ul>
            </script>
        </div>
    </template>
</dom-module>

<script>
    Polymer({
        is: "kubi-period-view",
        modelConnected : function(event, details){
            testPeriod(details.value);
            initTemplatePeriod("periodView_template", "periodView", 0, (new Date()).getTime());
        },
        ready : function (){
            try{
                if (this.$.modelHandlerPeriod.modelAvailable())
                {
                    testPeriod(this.$.modelHandlerPeriod.model());
                    initTemplatePeriod("periodView_template", "periodView", 0, (new Date()).getTime());
                }
            }catch (err){console.error(err);}


            paperclip.modifiers.timestampToDateConverter = function (timestamp){
                var date = new Date(timestamp);
                return (date.getDate()<10?("0"+date.getDate()):date.getDate())+"/"
                        +   ((date.getMonth()+1)<10?("0"+(date.getMonth()+1)):(date.getMonth()+1))+"/"
                        +   (date.getFullYear()) +" At "
                        +   (date.getHours()<10?("0"+date.getHours()):date.getHours()) +":"
                        +   (date.getMinutes()<10?("0"+date.getMinutes()):date.getMinutes())+":"
                        +   (date.getSeconds()<10?("0"+date.getSeconds()):date.getSeconds());
            }
        }



    });
</script>
